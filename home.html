<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#000000">
<title>Tokera</title>

<style>
body{
margin:0;
background:#111;
color:white;
font-family:Arial;
}

/* TOP BAR */
#topbar{
background:#1a1a1a;
padding:12px;
display:flex;
justify-content:space-between;
align-items:center;
}

.ticket{color:#ff5555;}

/* CONTENT */
#content{
padding:20px;
text-align:center;
margin-bottom:80px;
}

/* DOWN BAR */
#downbar{
position:fixed;
bottom:0;
width:100%;
background:#1a1a1a;
display:flex;
justify-content:space-around;
padding:12px 0;
}

.downbtn{cursor:pointer;}

/* CARDS */
.userCard,.gameCard{
background:#222;
margin:10px;
padding:14px;
border-radius:10px;
}

/* STATUS */
.online{color:#00ff88;}
.offline{color:#888;}

/* GAMES */
.gamesGrid{
display:grid;
grid-template-columns:repeat(auto-fill,minmax(140px,1fr));
gap:14px;
margin-top:20px;
}

.gameIcon{
width:80px;
height:80px;
border-radius:16px;
object-fit:cover;
margin-bottom:8px;
}

.playBtn{
background:#00ff88;
border:none;
border-radius:6px;
padding:8px;
cursor:pointer;
width:100%;
}

.playBtn:disabled{
opacity:.5;
cursor:not-allowed;
}
</style>
</head>

<body>

<div id="topbar">
<div>Tokera</div>
<div id="userInfo">...</div>
</div>

<div id="content">Carregando...</div>

<div id="downbar">
<div class="downbtn" onclick="goHome()">Home</div>
<div class="downbtn" onclick="openUsers()">Users</div>
<div class="downbtn" onclick="openFriends()">Friends</div>
<div class="downbtn" onclick="openShop()">Shop</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getDatabase,ref,get,set,update,onValue,onDisconnect }
from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

/* FIREBASE */
const firebaseConfig={
apiKey:"AIzaSyBzWOV7rpIQTB43cJtJMOuSazm6KxfMQP4",
authDomain:"tokera-2244b.firebaseapp.com",
databaseURL:"https://tokera-2244b-default-rtdb.firebaseio.com",
projectId:"tokera-2244b",
storageBucket:"tokera-2244b.firebasestorage.app",
messagingSenderId:"516093605358",
appId:"1:516093605358:web:56b055ec770a9e93270aff"
};

const app=initializeApp(firebaseConfig);
const db=getDatabase(app);

const content=document.getElementById("content");
const userInfo=document.getElementById("userInfo");

/* LOGIN */
let usuarioAtual=localStorage.getItem("usuario");

if(!usuarioAtual) mostrarLogin();
else startApp();

function mostrarLogin(){
content.innerHTML=`
<h2>Login</h2>
<input id="nome" placeholder="Usu√°rio"><br><br>
<input id="senha" type="password" placeholder="Senha"><br><br>
<button onclick="login()">Entrar</button>
`;
}

window.login=async function(){
const nome=document.getElementById("nome").value.trim().toLowerCase();
const senha=document.getElementById("senha").value.trim();
if(!nome||!senha) return alert("Preencha tudo");

const userRef=ref(db,"usuarios/"+nome);
const snap=await get(userRef);

if(!snap.exists()){
await set(userRef,{
senha,
ticket:0,
online:true,
PFP:0,
amigos:{},
presentes:{pendentes:0}
});
}else if(snap.val().senha!==senha){
return alert("Senha errada");
}

localStorage.setItem("usuario",nome);
usuarioAtual=nome;
startApp();
};

/* START */
async function startApp(){
const onlineRef=ref(db,"usuarios/"+usuarioAtual+"/online");
await set(onlineRef,true);
onDisconnect(onlineRef).set(false);

checkPresentes();
dailyTicket();

onValue(ref(db,"usuarios/"+usuarioAtual),(snap)=>{
const d=snap.val();
const pfp=d.PFP==1
? `<img src="https://avatars.githubusercontent.com/u/2505495?v=4"
style="width:32px;height:32px;border-radius:50%;vertical-align:middle;"> `
: "";

userInfo.innerHTML=`${pfp}<span class="ticket">üéü ${d.ticket}</span> ${usuarioAtual}`;
});

goHome();
}

/* PRESENTES */
async function checkPresentes(){
const refUser=ref(db,"usuarios/"+usuarioAtual);
const snap=await get(refUser);
const d=snap.val();

if(d.presentes?.pendentes>0){
const qtd=d.presentes.pendentes;
const ganho=qtd*5;

alert(`üéÅ Voc√™ recebeu ${qtd} presente(s)!\n+${ganho} tickets`);

await update(refUser,{
ticket:d.ticket+ganho,
"presentes/pendentes":0
});
}
}

/* DAILY TICKET */
async function dailyTicket(){
const hoje=new Date().toDateString();
if(localStorage.getItem("lastTicket")===hoje) return;

const refUser=ref(db,"usuarios/"+usuarioAtual);
const snap=await get(refUser);
await update(refUser,{ticket:(snap.val().ticket||0)+1});
localStorage.setItem("lastTicket",hoje);
}

/* HOME */
window.goHome=function(){
content.innerHTML=`
<h1>Home</h1>
<div class="gamesGrid">
<div class="gameCard">
<img class="gameIcon" src="https://play-lh.googleusercontent.com/SWTpYqsX9RN2YirCDnAjQ8qsbgn4UrHkRRGsjwuASnHMVqssIvWKzq82mP82y_ffBSE">
<p>Paper.io</p>
<button class="playBtn" onclick="window.open('https://games.voodoo.io/paperio2/')">Play</button>
</div>

<div class="gameCard">
<img class="gameIcon" src="https://upload.wikimedia.org/wikipedia/en/c/ca/Hole.io_logo.jpg">
<p>Hole.io</p>
<button class="playBtn" onclick="window.open('https://holeio.com/')">Play</button>
</div>
</div>
`;
};

/* USERS */
window.openUsers=function(){
onValue(ref(db,"usuarios"),snap=>{
let html="<h2>Users</h2>";
snap.forEach(u=>{
const nome=u.key;
if(nome===usuarioAtual) return;
const d=u.val();

const img=d.PFP==1
? `<img src="https://avatars.githubusercontent.com/u/2505495?v=4" width="40" style="border-radius:50%"><br>`
:"";

html+=`
<div class="userCard">
${img}
<b>${nome}</b>
<span class="${d.online?'online':'offline'}">(${d.online?'On':'Off'})</span><br><br>
<button onclick="addFriend('${nome}')">Adicionar amigo</button><br><br>
<button onclick="sendGift('${nome}')">üéÅ Enviar presente (5 üéü)</button>
</div>`;
});
content.innerHTML=html;
});
};

window.addFriend=async function(nome){
await set(ref(db,"usuarios/"+usuarioAtual+"/amigos/"+nome),true);
alert("Amigo adicionado!");
};

window.sendGift=async function(nome){
const meRef=ref(db,"usuarios/"+usuarioAtual);
const toRef=ref(db,"usuarios/"+nome);

const me=(await get(meRef)).val();
if(me.ticket<5) return alert("Voc√™ precisa de 5 tickets!");

const to=(await get(toRef)).val();
const pend=to.presentes?.pendentes||0;

await update(meRef,{ticket:me.ticket-5});
await update(toRef,{"presentes/pendentes":pend+1});

alert("üéÅ Presente enviado!");
};

/* FRIENDS */
window.openFriends=function(){
onValue(ref(db,"usuarios/"+usuarioAtual+"/amigos"),async snap=>{
let html="<h2>Amigos</h2>";
if(!snap.exists()){
content.innerHTML=html+"<p>Nenhum amigo</p>";
return;
}
for(const nome in snap.val()){
const d=(await get(ref(db,"usuarios/"+nome))).val();
html+=`
<div class="userCard">
${nome}
<span class="${d.online?'online':'offline'}">(${d.online?'On':'Off'})</span>
</div>`;
}
content.innerHTML=html;
});
};

/* SHOP */
window.openShop=async function(){
const d=(await get(ref(db,"usuarios/"+usuarioAtual))).val();

content.innerHTML=`
<h2>Shop</h2>
<div class="gameCard">
<img class="gameIcon" src="https://avatars.githubusercontent.com/u/2505495?v=4">
<p>Gatinho na Cama</p>
<p>Custo: üéü 1</p>
<button class="playBtn" ${d.PFP==1?"disabled":""}
onclick="comprarPFP()">
${d.PFP==1?"Equipado":"Comprar"}
</button>
</div>
`;
};

window.comprarPFP=async function(){
const refUser=ref(db,"usuarios/"+usuarioAtual);
const d=(await get(refUser)).val();

if(d.ticket<1) return alert("Sem tickets");

await update(refUser,{ticket:d.ticket-1,PFP:1});
alert("PFP equipado!");
openShop();
};
</script>

</body>
</html>
