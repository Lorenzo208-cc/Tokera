<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#000000">

<title>tokera</title>

<style>

body{
margin:0;
background:#111;
color:white;
font-family:Arial;
}

#topbar{
background:#1a1a1a;
padding:12px;
display:flex;
justify-content:space-between;
align-items:center;
}

.ticket{
color:#ff5555;
}

#content{
padding:20px;
text-align:center;
margin-bottom:70px;
}

#downbar{
position:fixed;
bottom:0;
width:100%;
background:#1a1a1a;
display:flex;
justify-content:space-around;
padding:12px 0;
}

.downbtn{
cursor:pointer;
}

.userCard{
background:#222;
margin:10px;
padding:14px;
border-radius:8px;
}

.online{color:#00ff88;}
.offline{color:#888;}

.mobile body{font-size:18px;}

.mobile button{
width:100%;
padding:14px;
margin-top:10px;
font-size:18px;
}

.mobile input{
width:90%;
padding:14px;
font-size:18px;
}

</style>
</head>

<body>

<div id="topbar">
<div>tokera</div>
<div id="userInfo">...</div>
</div>

<div id="content">Carregando...</div>

<div id="downbar">
<div class="downbtn" onclick="goHome()">Home</div>
<div class="downbtn" onclick="openUsers()">Users</div>
<div class="downbtn" onclick="openFriends()">Friends</div>
<div class="downbtn" onclick="openShop()">Shop</div>
</div>

<script type="module">

import { initializeApp } from
"https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";

import {
getDatabase,ref,get,set,update,onValue,onDisconnect
} from
"https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

/* FIREBASE */
const firebaseConfig={
apiKey:"AIzaSyBzWOV7rpIQTB43cJtJMOuSazm6KxfMQP4",
authDomain:"tokera-2244b.firebaseapp.com",
databaseURL:"https://tokera-2244b-default-rtdb.firebaseio.com",
projectId:"tokera-2244b",
storageBucket:"tokera-2244b.firebasestorage.app",
messagingSenderId:"516093605358",
appId:"1:516093605358:web:56b055ec770a9e93270aff"
};

const app=initializeApp(firebaseConfig);
const db=getDatabase(app);

const content=document.getElementById("content");
const userInfo=document.getElementById("userInfo");

/* MOBILE MODE */
if(window.innerWidth<700){
document.documentElement.classList.add("mobile");
}

/* LOGIN */
let usuarioAtual=localStorage.getItem("usuario");

if(!usuarioAtual){
mostrarLogin();
}else{
startApp();
}

function mostrarLogin(){
content.innerHTML=`
<h2>Login</h2>
<input id="nome" placeholder="UsuÃ¡rio"><br><br>
<input id="senha" type="password" placeholder="Senha"><br>
<button onclick="login()">Entrar</button>
`;
}

window.login=async function(){

const nome=document.getElementById("nome").value.trim().toLowerCase();
const senha=document.getElementById("senha").value.trim();

if(!nome||!senha)return alert("Preencha tudo");

const userRef=ref(db,"usuarios/"+nome);
const snap=await get(userRef);

if(snap.exists()){
if((snap.val().senha||"")!==senha){
alert("Senha errada");
return;
}
}else{
await set(userRef,{
senha:senha,
ticket:0,
online:true,
criadoEm:new Date().toLocaleDateString(),
amigos:{}
});
}

localStorage.setItem("usuario",nome);
usuarioAtual=nome;
startApp();
};

/* START APP */
async function startApp(){

const onlineRef=ref(db,"usuarios/"+usuarioAtual+"/online");

await set(onlineRef,true);
onDisconnect(onlineRef).set(false);

dailyTicket();

onValue(ref(db,"usuarios/"+usuarioAtual),(snap)=>{
const d=snap.val();
userInfo.innerHTML=
`<span class="ticket">ðŸŽŸ ${d.ticket}</span> ${usuarioAtual}`;
});

goHome();
}

/* DAILY TICKET */
async function dailyTicket(){

const hoje=new Date().toDateString();
const ultimo=localStorage.getItem("lastTicket");

if(hoje===ultimo)return;

const userRef=ref(db,"usuarios/"+usuarioAtual);
const snap=await get(userRef);

let t=snap.val().ticket||0;

await update(userRef,{ticket:t+1});
localStorage.setItem("lastTicket",hoje);
}

/* HOME */
window.goHome=function(){
content.innerHTML="<h1>Home</h1><p>Bem-vindo ao Tokera</p>";
};

/* USERS */
window.openUsers=function(){

onValue(ref(db,"usuarios"),(snap)=>{

let html="<h2>Users</h2>";

snap.forEach(userSnap=>{

const nome=userSnap.key;
const dados=userSnap.val();

if(nome===usuarioAtual)return;

const status=dados.online?"On-line":"Off-line";
const classe=dados.online?"online":"offline";

html+=`
<div class="userCard">

<div>
<b>${nome}</b>
<span class="${classe}">(${status})</span>
</div>

<button onclick="addFriend('${nome}')">
Adicionar amigo
</button>

</div>
`;
});

content.innerHTML=html;
});
};

/* ADD FRIEND */
window.addFriend=async function(nome){

await set(
ref(db,"usuarios/"+usuarioAtual+"/amigos/"+nome),
true
);

alert("Amigo adicionado!");
};

/* FRIENDS LIST */
window.openFriends=function(){

onValue(
ref(db,"usuarios/"+usuarioAtual+"/amigos"),
async(snap)=>{

let html="<h2>Amigos</h2>";

if(!snap.exists()){
content.innerHTML=html+"<p>Nenhum amigo</p>";
return;
}

for(const nome in snap.val()){

const u=await get(ref(db,"usuarios/"+nome));
const d=u.val();

html+=`
<div class="userCard">
${nome}
<span class="${d.online?'online':'offline'}">
(${d.online?'On-line':'Off-line'})
</span>
</div>`;
}

content.innerHTML=html;
});
};

/* SHOP */
window.openShop=function(){
content.innerHTML="<h2>Shop</h2><p>Nenhum item ainda</p>";
};

</script>

</body>
</html>
