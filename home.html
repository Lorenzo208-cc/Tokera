<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#000000">
<title>Tokera</title>

<style>
body{
margin:0;
background:#111;
color:white;
font-family:Arial;
}

/* TOP BAR */
#topbar{
background:#1a1a1a;
padding:12px;
display:flex;
justify-content:space-between;
align-items:center;
}

.ticket{color:#ff5555;}
.coin{color:#ffd700;}

/* CONTENT */
#content{
padding:20px;
text-align:center;
margin-bottom:80px;
}

/* DOWN BAR */
#downbar{
position:fixed;
bottom:0;
width:100%;
background:#1a1a1a;
display:flex;
justify-content:space-around;
padding:12px 0;
}

.downbtn{cursor:pointer;}

/* CARDS */
.userCard,.gameCard{
background:#222;
margin:10px;
padding:14px;
border-radius:10px;
}

/* STATUS */
.online{color:#00ff88;}
.offline{color:#888;}

/* GAMES */
.gamesGrid{
display:grid;
grid-template-columns:repeat(auto-fill,minmax(140px,1fr));
gap:14px;
margin-top:20px;
}

.gameIcon{
width:80px;
height:80px;
border-radius:16px;
object-fit:cover;
margin-bottom:8px;
}

.playBtn{
background:#00ff88;
border:none;
border-radius:6px;
padding:8px;
cursor:pointer;
width:100%;
}

.playBtn:disabled{
opacity:.5;
cursor:not-allowed;
}
</style>
</head>

<body>

<div id="topbar">
<div>Tokera</div>
<div id="userInfo">...</div>
</div>

<div id="content">Carregando...</div>

<div id="downbar">
<div class="downbtn" onclick="goHome()">Home</div>
<div class="downbtn" onclick="openUsers()">Users</div>
<div class="downbtn" onclick="openFriends()">Friends</div>
<div class="downbtn" onclick="openBank()">Bank</div>
<div class="downbtn" onclick="openShop()">Shop</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getDatabase,ref,get,set,update,onValue,onDisconnect }
from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

/* FIREBASE */
const firebaseConfig={
apiKey:"AIzaSyBzWOV7rpIQTB43cJtJMOuSazm6KxfMQP4",
authDomain:"tokera-2244b.firebaseapp.com",
databaseURL:"https://tokera-2244b-default-rtdb.firebaseio.com",
projectId:"tokera-2244b",
storageBucket:"tokera-2244b.firebasestorage.app",
messagingSenderId:"516093605358",
appId:"1:516093605358:web:56b055ec770a9e93270aff"
};

const app=initializeApp(firebaseConfig);
const db=getDatabase(app);

const content=document.getElementById("content");
const userInfo=document.getElementById("userInfo");

/* LOGIN */
let usuarioAtual=localStorage.getItem("usuario");

if(!usuarioAtual) mostrarLogin();
else startApp();

function mostrarLogin(){
content.innerHTML=`
<h2>Login</h2>
<input id="nome" placeholder="Usu√°rio"><br><br>
<input id="senha" type="password" placeholder="Senha"><br><br>
<button onclick="login()">Entrar</button>
`;
}

window.login=async function(){
const nome=document.getElementById("nome").value.trim().toLowerCase();
const senha=document.getElementById("senha").value.trim();
if(!nome||!senha) return alert("Preencha tudo");

const userRef=ref(db,"usuarios/"+nome);
const snap=await get(userRef);

if(!snap.exists()){
await set(userRef,{
senha,
ticket:0,
tokecoin:0,
online:true,
PFP:0,
amigos:{},
presentes:{pendentes:0}
});
}else if(snap.val().senha!==senha){
return alert("Senha errada");
}

localStorage.setItem("usuario",nome);
usuarioAtual=nome;
startApp();
};

/* START */
async function startApp(){
const onlineRef=ref(db,"usuarios/"+usuarioAtual+"/online");
await set(onlineRef,true);
onDisconnect(onlineRef).set(false);

checkPresentes();
dailyTicket();

onValue(ref(db,"usuarios/"+usuarioAtual),(snap)=>{
const d=snap.val();

userInfo.innerHTML=`
<span class="ticket">üéü ${d.ticket||0}</span>
&nbsp;&nbsp;
<span class="coin">ü™ô ${d.tokecoin||0}</span>
`;
});

goHome();
}

/* PRESENTES */
async function checkPresentes(){
const refUser=ref(db,"usuarios/"+usuarioAtual);
const snap=await get(refUser);
const d=snap.val();

if(d.presentes?.pendentes>0){
const qtd=d.presentes.pendentes;
const ganho=qtd*5;

alert(`üéÅ Voc√™ recebeu ${qtd} presente(s)!\n+${ganho} tickets`);

await update(refUser,{
ticket:d.ticket+ganho,
"presentes/pendentes":0
});
}
}

/* DAILY */
async function dailyTicket(){
const hoje=new Date().toDateString();
if(localStorage.getItem("lastTicket")===hoje) return;

const refUser=ref(db,"usuarios/"+usuarioAtual);
const snap=await get(refUser);
await update(refUser,{ticket:(snap.val().ticket||0)+1});
localStorage.setItem("lastTicket",hoje);
}

/* HOME */
window.goHome=function(){
content.innerHTML=`<h1>Home</h1>`;
};

/* BANK */
window.openBank=async function(){
const d=(await get(ref(db,"usuarios/"+usuarioAtual))).val();

content.innerHTML=`
<h2>üè¶ Bank</h2>

<div class="gameCard">
<p>Converter Tickets em TokeCoin</p>

<p>Taxa:</p>
<p><b>10 üéü = 1 ü™ô</b></p>

<br>

<button class="playBtn"
${d.ticket<10?"disabled":""}
onclick="converterCoin()">
Converter
</button>

<br><br>
<p>Seus Tickets: üéü ${d.ticket}</p>
<p>Suas Coins: ü™ô ${d.tokecoin||0}</p>
</div>
`;
};

window.converterCoin=async function(){
const refUser=ref(db,"usuarios/"+usuarioAtual);
const d=(await get(refUser)).val();

if(d.ticket<10) return alert("Precisa de 10 tickets!");

await update(refUser,{
ticket:d.ticket-10,
tokecoin:(d.tokecoin||0)+1
});

alert("ü™ô Convers√£o feita!");
openBank();
};

/* USERS */
window.openUsers=function(){
onValue(ref(db,"usuarios"),snap=>{
let html="<h2>Users</h2>";
snap.forEach(u=>{
const nome=u.key;
if(nome===usuarioAtual) return;
const d=u.val();

html+=`
<div class="userCard">
<b>${nome}</b>
<span class="${d.online?'online':'offline'}">
(${d.online?'On':'Off'})
</span><br><br>

<button onclick="addFriend('${nome}')">
Adicionar amigo
</button>
</div>`;
});
content.innerHTML=html;
});
};

window.addFriend=async function(nome){
await set(ref(db,"usuarios/"+usuarioAtual+"/amigos/"+nome),true);
alert("Amigo adicionado!");
};

/* FRIENDS */
window.openFriends=function(){
onValue(ref(db,"usuarios/"+usuarioAtual+"/amigos"),async snap=>{
let html="<h2>Amigos</h2>";
if(!snap.exists()){
content.innerHTML=html+"<p>Nenhum amigo</p>";
return;
}
for(const nome in snap.val()){
const d=(await get(ref(db,"usuarios/"+nome))).val();
html+=`
<div class="userCard">
${nome}
<span class="${d.online?'online':'offline'}">
(${d.online?'On':'Off'})
</span>
</div>`;
}
content.innerHTML=html;
});
};

/* SHOP */
window.openShop=function(){
content.innerHTML=`<h2>Shop</h2><p>Em breve...</p>`;
};
</script>

</body>
</html>
